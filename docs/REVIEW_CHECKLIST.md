# CUDA + PTX Microbenchmark 代码审查检查清单

## 使用方法

1. 在审查每个文件前，阅读完整文件理解上下文
2. 逐条检查以下项目
3. 发现问题时记录文件路径和行号
4. 最后汇总审查结果

---

## 第一部分：CUDA代码质量

### 1.1 内核函数设计

- [ ] 线程索引计算正确：`blockIdx.x * blockDim.x + threadIdx.x`
- [ ] 多维索引计算正确（如有）
- [ ] 所有内存访问都有边界检查
- [ ] warp内线程发散最小化
- [ ] 寄存器使用合理（无过多spill）
- [ ] 共享内存访问无bank conflict
- [ ] block大小是32的倍数
- [ ] grid大小计算正确：`(n + block - 1) / block`

### 1.2 内存管理

- [ ] 所有`cudaMalloc`检查返回值
- [ ] 每个`cudaMalloc`有对应的`cudaFree`
- [ ] 使用RAII或确保异常安全
- [ ] 全局内存访问对齐到16字节
- [ ] 内存拷贝方向正确
- [ ] 无内存泄漏（使用cuda-memcheck验证）

### 1.3 错误处理

- [ ] 使用`CUDA_CHECK`宏包装CUDA调用
- [ ] 内核启动后调用`cudaGetLastError()`
- [ ] 需要时调用`cudaDeviceSynchronize()`
- [ ] 错误信息清晰，包含文件和行号
- [ ] 错误路径上有适当的清理逻辑

### 1.4 流和同步

- [ ] 默认流使用合理（了解其阻塞特性）
- [ ] 流间依赖关系正确
- [ ] 异步操作正确使用
- [ ] 事件用于精确计时

---

## 第二部分：PTX汇编代码

### 2.1 PTX语法

- [ ] 指令格式正确（操作数顺序）
- [ ] 修饰符使用正确（.ca/.cg/.cs等）
- [ ] PTX版本与目标架构兼容
- [ ] 谓词指令语法正确

### 2.2 约束列表

- [ ] 约束字符与数据类型匹配
  - `r` = 32位通用寄存器
  - `l` = 64位通用寄存器
  - `f` = 32位浮点
  - `d` = 64位浮点
- [ ] 内存操作声明`"memory"` clobber
- [ ] 修改的特殊寄存器声明
- [ ] 谓词寄存器修改声明

### 2.3 输入/输出操作数

- [ ] 输出操作数使用`=`或`+`约束
- [ ] 早期clobber使用`&`（如需要）
- [ ] 立即数使用`n`约束
- [ ] 输入输出无寄存器冲突

### 2.4 集成安全

- [ ] 使用`volatile`关键字
- [ ] 内存序一致性正确
- [ ] 寄存器压力可接受

---

## 第三部分：性能测试代码

### 3.1 计时方法

- [ ] 使用CUDA事件而非CPU计时器
- [ ] 事件创建/销毁开销已考虑
- [ ] 测量持续时间足够（>100微秒）
- [ ] 时钟分辨率了解并记录

### 3.2 干扰因素消除

- [ ] GPU充分预热（>10次空跑）
- [ ] 等待频率稳定
- [ ] 编译器优化屏障使用正确
- [ ] 防止测试代码被优化
- [ ] 后台进程已清理
- [ ] GPU独占使用（如可能）

### 3.3 测量精度

- [ ] 样本量足够（>=30）
- [ ] 冷/热缓存状态控制
- [ ] 统计分析方法正确（中位数、百分位）
- [ ] 异常值处理合理

---

## 第四部分：RTX 4070特定优化

### 4.1 架构特性

- [ ] 编译目标`-arch=sm_89`
- [ ] 了解Ada Lovelace特性
- [ ] 考虑46个SM的并行度
- [ ] 寄存器文件大小了解（64K per SM）

### 4.2 缓存配置

- [ ] L2缓存大小了解（48MB）
- [ ] 缓存修饰符使用正确
- [ ] 缓存行对齐（128字节）
- [ ] L1缓存策略合理

### 4.3 共享内存

- [ ] 共享内存大小限制（128KB per SM）
- [ ] Bank conflict避免
- [ ] 动态共享内存计算正确

---

## 第五部分：安全性和健壮性

### 5.1 边界检查

- [ ] 所有数组访问前验证索引
- [ ] 指针解引用前检查非空
- [ ] 动态尺寸运行时验证
- [ ] 64位索引用于大数组

### 5.2 数值安全

- [ ] 除法前检查除数非零
- [ ] 开方前检查参数非负
- [ ] 对数参数大于零
- [ ] 浮点异常处理

### 5.3 资源管理

- [ ] 显存分配失败处理
- [ ] 流创建/销毁配对
- [ ] 事件创建/销毁配对
- [ ] 纹理/表面资源释放

### 5.4 错误处理

- [ ] 错误传播机制
- [ ] 部分失败处理
- [ ] 用户友好的错误信息
- [ ] 日志记录完整

---

## 审查结果汇总

### 发现的问题

| 序号 | 严重级别 | 类别 | 文件:行号 | 问题描述 | 建议修复 |
|------|----------|------|-----------|----------|----------|
| 1 | | | | | |
| 2 | | | | | |
| 3 | | | | | |

### 统计

| 严重级别 | 数量 | 状态 |
|----------|------|------|
| CRITICAL | | |
| HIGH | | |
| MEDIUM | | |
| LOW | | |

### 审查结论

- [ ] APPROVE - 无阻塞问题
- [ ] WARNING - 存在HIGH问题，需谨慎合并
- [ ] BLOCK - 存在CRITICAL问题，必须修复

### 备注

---

## 快速参考

### 严重级别定义

- **CRITICAL**: 可能导致崩溃、数据损坏或安全漏洞
- **HIGH**: 可能导致性能严重下降或难以调试的错误
- **MEDIUM**: 代码质量问题，建议修复
- **LOW**: 风格问题，可选修复

### 关键检查点

1. **必须检查**: 边界检查、错误处理、内存管理
2. **PTX必须**: 约束正确、memory clobber、volatile
3. **性能必须**: 预热、CUDA事件计时、统计显著性
4. **4070必须**: sm_89编译、48MB L2考虑

### 工具命令

```bash
# 内存检查
cuda-memcheck --tool memcheck ./benchmark
compute-sanitizer --tool memcheck ./benchmark

# 性能分析
ncu --metrics l1tex__t_sectors_pipe_lsu_mem_global_op_ld.sum \
    ./benchmark

# 生成PTX/SASS
nvcc -arch=sm_89 -ptx -o output.ptx input.cu
nvcc -arch=sm_89 -cubin -o output.cubin input.cu
nvdisasm output.cubin > output.sass
```
